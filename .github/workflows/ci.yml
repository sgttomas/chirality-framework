name: CI Pipeline

on:
  push:
    branches: [ main, experimental-*, feature-*, fix-* ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.13"

jobs:
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install mypy black ruff
    
    - name: Run Black (code formatting)
      run: black --check chirality/ tests/
    
    - name: Run Ruff (linting) 
      run: ruff check chirality/ tests/
    
    - name: Run MyPy (type checking)
      run: mypy chirality/
      continue-on-error: true  # Type checking is advisory for now

  test-architecture:
    name: Test Prompt System Architecture
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]" 
        pip install pytest pytest-cov pyyaml
        
    - name: Debug package structure
      run: |
        echo "=== Package structure debug ==="
        python -c "import sys; print('Python path:', sys.path)"
        python -c "import os; print('CWD contents:', os.listdir('.'))"
        python -c "import os; print('chirality/ contents:', os.listdir('chirality'))"
        python -c "import os; print('chirality/lib/ contents:', os.listdir('chirality/lib') if os.path.exists('chirality/lib') else 'MISSING')"
        echo "=== Try import chirality ==="
        python -c "import chirality; print('✓ chirality import OK')"
        echo "=== Try import chirality.lib ==="
        python -c "import chirality.lib; print('✓ chirality.lib import OK')"
        echo "=== Try import specific modules ==="
        python -c "from chirality.lib.prompt_builder import PromptBuilder; print('✓ PromptBuilder import OK')"
    
    - name: Validate prompt asset integrity
      run: |
        echo "Validating prompt asset structure..."
        python -c "
        from chirality.lib.prompt_registry import PromptRegistry
        from pathlib import Path
        import sys
        
        try:
            # Test registry loads without errors
            registry = PromptRegistry()
            registry.load()
            assets = list(registry._assets.keys())
            
            print(f'✓ Successfully loaded {len(assets)} prompt assets')
            print(f'Available assets: {sorted(assets)}')
            
            # Verify core assets exist (NEW ARCHITECTURE)
            required_assets = [
                'stage2_multiply', 'stage2_elementwise', 'combined_lens', 'station_shift',
                'station_brief.requirements', 'station_brief.objectives',
                'station_brief.verification', 'station_brief.validation', 'station_brief.evaluation'
            ]
            
            missing = []
            for asset_id in required_assets:
                try:
                    registry.get(asset_id)
                except KeyError:
                    missing.append(asset_id)
            
            if missing:
                print(f'✗ Missing required assets: {missing}')
                sys.exit(1)
            else:
                print('✓ All required assets present')
                
        except Exception as e:
            print(f'✗ Prompt asset validation failed: {e}')
            sys.exit(1)
        "
    
    - name: Test combined lensing architecture
      run: pytest tests/test_combined_lensing_architecture.py -v
    
    - name: Run package verification
      run: python verify_package.py

  test-core:
    name: Test Core Framework
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install pytest pytest-cov
    
    - name: Test core operations (echo resolver)
      run: pytest tests/core/test_operations.py -v
    
    - name: Test exporters
      run: pytest tests/exporters/ -v
    
    - name: Test CLI functionality
      run: pytest tests/test_cli.py -v

  test-api-compliance:
    name: Test OpenAI Responses API Compliance
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python  
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install pytest
    
    - name: Test API compliance
      run: pytest tests/test_api_compliance.py -v
      
  validate-semantic-integrity:
    name: Validate Semantic Integrity Rules
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Validate normative spec unchanged
      run: |
        echo "Validating normative specification integrity..."
        python -c "
        from pathlib import Path
        import hashlib
        import sys
        
        # Read normative spec
        normative_path = Path('chirality/normative_spec.txt')
        if not normative_path.exists():
            print('✗ Normative specification file missing!')
            sys.exit(1)
            
        content = normative_path.read_text()
        
        # Verify it contains key semantic rules
        required_sections = [
            'The Chirality Framework',
            'semantic multiplication',
            'ontological lensing'
        ]
        
        missing = []
        for section in required_sections:
            if section.lower() not in content.lower():
                missing.append(section)
        
        if missing:
            print(f'✗ Missing required sections in normative spec: {missing}')
            sys.exit(1)
        
        print('✓ Normative specification integrity validated')
        print(f'✓ Spec contains {len(content)} characters')
        "
    
    - name: Check for prohibited Chat Completions API usage
      run: |
        echo "Checking for prohibited OpenAI Chat Completions API usage..."
        if grep -r "chat\.completions\.create" chirality/ --include="*.py"; then
          echo "✗ CRITICAL: Found prohibited Chat Completions API usage!"
          echo "✗ The Chirality Framework MUST use OpenAI Responses API exclusively"
          exit 1
        else
          echo "✓ No prohibited Chat Completions API usage found"
        fi
        
        # Verify correct Responses API usage
        if grep -r "responses\.create" chirality/ --include="*.py"; then
          echo "✓ Correct Responses API usage found"
        else
          echo "⚠ Warning: No Responses API usage found (may be expected if no LLM integration)"
        fi

  cli-smoke-test:
    name: CLI Smoke Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Test CLI info command
      run: python -m chirality.cli info
    
    - name: Test CLI compute-cell with echo resolver
      run: |
        python -m chirality.cli compute-cell C --i 0 --j 0 --resolver echo --verbose
    
    - name: Test CLI matrix operations
      run: |
        # Test different matrix types with echo resolver
        python -m chirality.cli compute-cell F --i 1 --j 2 --resolver echo
        python -m chirality.cli compute-cell D --i 2 --j 1 --resolver echo

  dependency-security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit
    
    - name: Run Safety (known vulnerabilities)
      run: safety check --json || true
    
    - name: Run pip-audit (dependency audit)
      run: pip-audit --format=json || true

  build-test:
    name: Build & Installation Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Test clean installation
      run: |
        python -m pip install --upgrade pip build
        python -m build
    
    - name: Test wheel installation
      run: |
        pip install dist/*.whl
        python -c "import chirality; print('✓ Package imports successfully')"
        python -c "from chirality.lib.strategies import PromptStrategy; print('✓ New prompt system available')"
        python -c "from chirality.lib.prompt_registry import PromptRegistry; r = PromptRegistry(); r.load(); print('✓ Prompt assets load successfully')"

  coverage-report:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]" 
        pip install pytest pytest-cov pyyaml
    
    - name: Run tests with coverage
      run: |
        pytest \
          tests/core/test_operations.py \
          tests/core/test_station5_validation.py \
          tests/core/test_station6_evaluation.py \
          tests/test_combined_lensing_architecture.py \
          tests/exporters/ \
          --cov=chirality \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=70
    
    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/